<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="redis," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Redisæ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§ç»“æ„çš„ã€çº¯å†…å­˜çš„KVå­˜å‚¨ç³»ç»Ÿã€‚
æ•°æ®æ ¼å¼æŸ¥çœ‹KEYçš„ç±»å‹å·²ç»ç¼–ç ç­‰ä¿¡æ¯çš„å‘½ä»¤ä¸ºï¼š

type keyï¼šç±»å‹ï¼›
object refcount keyï¼šè¢«å¼•ç”¨æ¬¡æ•°ï¼›
object encoding keyï¼šå†…éƒ¨ç¼–ç æ–¹å¼ï¼›
object idletime keyï¼šç©ºé—²æ—¶é—´ï¼Œä»æœ€åä¸€æ¬¡è¯»å†™å¼€å§‹ç®—ï¼›

æ•´ä½“çš„æ•°æ®ä¿å­˜ç»“æ„ï¼š

å¯¹åº”çš„typeå’Œencodingçš„å…³ç³»ï¼ˆä¸åŒç‰ˆæœ¬æœ‰å·®åˆ«çš„">
<meta property="og:type" content="article">
<meta property="og:title" content="REDIS">
<meta property="og:url" content="http://yoursite.com/2020/04/22/redis/index.html">
<meta property="og:site_name" content="wsztrush">
<meta property="og:description" content="Redisæ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§ç»“æ„çš„ã€çº¯å†…å­˜çš„KVå­˜å‚¨ç³»ç»Ÿã€‚
æ•°æ®æ ¼å¼æŸ¥çœ‹KEYçš„ç±»å‹å·²ç»ç¼–ç ç­‰ä¿¡æ¯çš„å‘½ä»¤ä¸ºï¼š

type keyï¼šç±»å‹ï¼›
object refcount keyï¼šè¢«å¼•ç”¨æ¬¡æ•°ï¼›
object encoding keyï¼šå†…éƒ¨ç¼–ç æ–¹å¼ï¼›
object idletime keyï¼šç©ºé—²æ—¶é—´ï¼Œä»æœ€åä¸€æ¬¡è¯»å†™å¼€å§‹ç®—ï¼›

æ•´ä½“çš„æ•°æ®ä¿å­˜ç»“æ„ï¼š

å¯¹åº”çš„typeå’Œencodingçš„å…³ç³»ï¼ˆä¸åŒç‰ˆæœ¬æœ‰å·®åˆ«çš„">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/04.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/01.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/02.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/14.jpg">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/00.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/15.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/07.jpg">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/05.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/08.jpg">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/09.jpg">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/10.png">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/13.jpg">
<meta property="og:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/12.jpg">
<meta property="og:updated_time" content="2020-05-21T10:23:17.768Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="REDIS">
<meta name="twitter:description" content="Redisæ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§ç»“æ„çš„ã€çº¯å†…å­˜çš„KVå­˜å‚¨ç³»ç»Ÿã€‚
æ•°æ®æ ¼å¼æŸ¥çœ‹KEYçš„ç±»å‹å·²ç»ç¼–ç ç­‰ä¿¡æ¯çš„å‘½ä»¤ä¸ºï¼š

type keyï¼šç±»å‹ï¼›
object refcount keyï¼šè¢«å¼•ç”¨æ¬¡æ•°ï¼›
object encoding keyï¼šå†…éƒ¨ç¼–ç æ–¹å¼ï¼›
object idletime keyï¼šç©ºé—²æ—¶é—´ï¼Œä»æœ€åä¸€æ¬¡è¯»å†™å¼€å§‹ç®—ï¼›

æ•´ä½“çš„æ•°æ®ä¿å­˜ç»“æ„ï¼š

å¯¹åº”çš„typeå’Œencodingçš„å…³ç³»ï¼ˆä¸åŒç‰ˆæœ¬æœ‰å·®åˆ«çš„">
<meta name="twitter:image" content="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/04.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'dc4364f27034e113a6c150023a648d49',
      author: 'wsztRush'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2020/04/22/redis/"/>


  <title> REDIS | wsztrush </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-CN">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ab1b083818fdf7317d4a77e34fe07f4c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">wsztrush</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">now or never!!!</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                REDIS
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2020-04-22T10:33:12+08:00" content="2020-04-22">
              2020-04-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/åŸºç¡€/" itemprop="url" rel="index">
                    <span itemprop="name">åŸºç¡€</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/22/redis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/22/redis/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2020/04/22/redis/" class="leancloud_visitors" data-flag-title="REDIS">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Redisæ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§ç»“æ„çš„ã€<font color="red">çº¯å†…å­˜</font>çš„KVå­˜å‚¨ç³»ç»Ÿã€‚</p>
<h1 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h1><p>æŸ¥çœ‹KEYçš„ç±»å‹å·²ç»ç¼–ç ç­‰ä¿¡æ¯çš„å‘½ä»¤ä¸ºï¼š</p>
<ul>
<li><code>type key</code>ï¼šç±»å‹ï¼›</li>
<li><code>object refcount key</code>ï¼šè¢«å¼•ç”¨æ¬¡æ•°ï¼›</li>
<li><code>object encoding key</code>ï¼šå†…éƒ¨ç¼–ç æ–¹å¼ï¼›</li>
<li><code>object idletime key</code>ï¼šç©ºé—²æ—¶é—´ï¼Œä»æœ€åä¸€æ¬¡è¯»å†™å¼€å§‹ç®—ï¼›</li>
</ul>
<p>æ•´ä½“çš„æ•°æ®ä¿å­˜ç»“æ„ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/04.png" alt=""></p>
<p>å¯¹åº”çš„typeå’Œencodingçš„å…³ç³»ï¼ˆä¸åŒç‰ˆæœ¬æœ‰å·®åˆ«çš„ï¼Œå˜åŒ–æœ‰ç‚¹å¿«ğŸ¤£ï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>type</th>
<th>encoding</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>long</td>
<td>æ•´æ•°</td>
</tr>
<tr>
<td>string</td>
<td>embstr</td>
<td>çŸ­å­—ç¬¦ä¸²(å°äº44)</td>
</tr>
<tr>
<td>string</td>
<td>sds</td>
<td>é•¿å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>list</td>
<td>quicklist</td>
<td>è²Œä¼¼ç°åœ¨çš„é»˜è®¤å®ç°ï¼Ÿ</td>
</tr>
<tr>
<td>hash</td>
<td>ziplist</td>
<td>å°å“ˆå¸Œè¡¨(64KBï¼Œ512)</td>
</tr>
<tr>
<td>hash</td>
<td>dict</td>
<td>å¤§å“ˆå¸Œè¡¨</td>
</tr>
<tr>
<td>set</td>
<td>intset</td>
<td>æ•´æ•°é›†åˆ(512)</td>
</tr>
<tr>
<td>set</td>
<td>dict</td>
<td>ä¸æ˜¯æ­£è¯´æˆ–å¤§é›†åˆ</td>
</tr>
<tr>
<td>zset</td>
<td>ziplist</td>
<td>æœ‰åºå°é›†åˆ(64KBï¼Œ128)</td>
</tr>
<tr>
<td>zset</td>
<td>zskiplist + dict</td>
<td>æœ‰åºå¤§é›†åˆ</td>
</tr>
<tr>
<td>stream</td>
<td>stream</td>
<td>æ¶ˆæ¯é˜Ÿåˆ—</td>
</tr>
</tbody>
</table>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ•´ä½“æ¥è¯´ï¼Œé‡å°çš„æ—¶å€™ç”¨æ•°ç»„ï¼Œé‡å¤§çš„æ—¶å€™å†ç”¨é“¾è¡¨ï¼Œè¿™æ ·æ¯”è¾ƒçœå†…å­˜ã€‚</p>
<p>çŸ­å­—ç¬¦ä½¿ç”¨embstræ ¼å¼ï¼š<font color="red">ç‰¹ç‚¹æ˜¯ä¸€æ¬¡åˆ†é…redisObjå’Œsdsï¼Œæ”¾åœ¨è¿ç»­çš„ç©ºé—´ä¸Šï¼Œå‡å°‘åˆ†é…å’Œé‡Šæ”¾çš„æ¬¡æ•°</font>ã€‚</p>
</blockquote>
<h2 id="å†…éƒ¨æ ¼å¼"><a href="#å†…éƒ¨æ ¼å¼" class="headerlink" title="å†…éƒ¨æ ¼å¼"></a>å†…éƒ¨æ ¼å¼</h2><h3 id="sds"><a href="#sds" class="headerlink" title="sds"></a>sds</h3><p>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼Œç”¨æ¥å­˜æ”¾å­—ç¬¦ä¸²ã€æ•°å­—ã€ä½å›¾ï¼Œä¸”äºŒè¿›åˆ¶å®‰å…¨ã€è®¿é—®å¿«ã€çœç©ºé—´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *sds;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> __attribute__ ((__packed__)) sdshdr8 &#123;</div><div class="line">    <span class="keyword">uint8_t</span> len; <span class="comment">/* used */</span></div><div class="line">    <span class="keyword">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></div><div class="line">    <span class="keyword">char</span> buf[];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ ¹æ®é•¿åº¦çš„ä¸åŒåˆ†åˆ«å®šä¹‰ä¸åŒçš„å¤´éƒ¨ï¼ŒCé‡Œé¢çš„æƒ¯ç”¨ç©æ³•ã€‚</p>
<p>è¿”å›çš„æ˜¯<font color="red">char*ï¼Œè¿™æ ·å…¼å®¹äº†Cå‡½æ•°ï¼Œç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•</font>ï¼Œå¹¶ä¸”flagsæ”¾åˆ°æœ€ä¸‹é¢å¾ˆå®¹æ˜“æ‰¾åˆ°ç»“æ„ä½“çš„èµ·ç‚¹ä½ç½®ã€‚</p>
<p>æ‰©å®¹ç­–ç•¥ï¼šå¦‚æœæ‰©å®¹åé•¿åº¦å°äº1MBï¼Œåˆ™æ‰©å®¹ä¸€å€ï¼Œå¦åˆ™å¢åŠ 1MBï¼Œæœ€å¤§æ˜¯512MBã€‚</p>
</blockquote>
<h3 id="zskiplist"><a href="#zskiplist" class="headerlink" title="zskiplist"></a>zskiplist</h3><p>è·³è·ƒè¡¨å¯ä»¥ä½æˆæœ¬åœ°å®ç°<font color="red">æœ‰åº</font>åˆ—è¡¨ï¼ˆ<font color="grey">ä¸»è¦è¿˜æ˜¯å†™èµ·æ¥ç®€å•</font>ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplistNode &#123;</div><div class="line">    sds ele; <span class="comment">// æ•°æ®</span></div><div class="line">    <span class="keyword">double</span> score; <span class="comment">// æ’åºä¾æ®çš„åˆ†å€¼</span></div><div class="line">    <span class="keyword">struct</span> zskiplistNode *backward; <span class="comment">// åé€€æŒ‡é’ˆ</span></div><div class="line">    <span class="keyword">struct</span> zskiplistLevel &#123;</div><div class="line">        <span class="keyword">struct</span> zskiplistNode *forward; <span class="comment">// æœ¬å±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> span; <span class="comment">// è·¨è¶Šçš„èŠ‚ç‚¹æ•°</span></div><div class="line">    &#125; level[]; <span class="comment">// éšæœºå±‚æ•°</span></div><div class="line">&#125; zskiplistNode;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplist &#123;</div><div class="line">    <span class="keyword">struct</span> zskiplistNode *header, *tail; <span class="comment">// å¤´ã€å°¾</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length; <span class="comment">// é•¿åº¦</span></div><div class="line">    <span class="keyword">int</span> level; <span class="comment">// é«˜åº¦</span></div><div class="line">&#125; zskiplist;</div></pre></td></tr></table></figure>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>åˆ†å€¼ç›¸åŒåˆ™æŒ‰å­—å…¸åºæ’åºã€‚</p>
<p>å¤§éƒ¨åˆ†æ“ä½œçš„å¤æ‚åº¦ä¸º$O(logN)$ï¼Œæœ€åå¤æ‚åº¦ä¸º$O(N)$ã€‚</p>
</blockquote>
<h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><p>åŒå‘é“¾è¡¨ï¼Œä¸ä»…åŒ…å«ç”¨æˆ·æ•°æ®ï¼Œåœ¨å¾ˆå¤šå†…éƒ¨ç®¡ç†ç»“æ„ä¸Šä¹Ÿæœ‰ç”¨åˆ°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> listNode &#123;</div><div class="line">    <span class="keyword">struct</span> listNode *prev; <span class="comment">// å‘å‰</span></div><div class="line">    <span class="keyword">struct</span> listNode *next; <span class="comment">// å‘å</span></div><div class="line">    <span class="keyword">void</span> *value; <span class="comment">// å€¼</span></div><div class="line">&#125; listNode;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="built_in">list</span> &#123;</div><div class="line">    listNode *head; <span class="comment">// å¤´</span></div><div class="line">    listNode *tail; <span class="comment">// å°¾</span></div><div class="line">    <span class="keyword">void</span> *(*dup)(<span class="keyword">void</span> *ptr); <span class="comment">// å¤åˆ¶å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *ptr); <span class="comment">// é‡Šæ”¾å‡½æ•°</span></div><div class="line">    <span class="keyword">int</span> (*match)(<span class="keyword">void</span> *ptr, <span class="keyword">void</span> *key); <span class="comment">// æ¯”è¾ƒå‡½æ•°</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len; <span class="comment">// é•¿åº¦</span></div><div class="line">&#125; <span class="built_in">list</span>;</div></pre></td></tr></table></figure>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>å¢åˆ æ”¹æ¯”è¾ƒå¿«ï¼ˆä¸éœ€è¦è€ƒè™‘å¤åˆ¶ã€æ‰©å®¹ç­‰ï¼‰ï¼ŒæŸ¥èµ·æ¥æ¯”è¾ƒæ…¢ã€‚</p>
</blockquote>
<h3 id="dict"><a href="#dict" class="headerlink" title="dict"></a>dict</h3><p>ç±»ä¼¼MAPï¼Œç›¸å…³çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictht &#123;</div><div class="line">    dictEntry **table; <span class="comment">// å“ˆå¸Œè¡¨æ•°ç»„</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size; <span class="comment">// tableå¤§å°</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask; <span class="comment">// å“ˆå¸Œè¡¨æ©ç ï¼Œsize - 1</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used; <span class="comment">// å“ˆå¸Œè¡¨ä¸­å·²æœ‰çš„èŠ‚ç‚¹æ•°</span></div><div class="line">&#125; dictht;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictEntry &#123;</div><div class="line">    <span class="keyword">void</span> *key; <span class="comment">// é”®</span></div><div class="line">    <span class="keyword">union</span> &#123; <span class="comment">// å€¼ï¼Œå¯ä»¥æ˜¯æ•°å­—</span></div><div class="line">        <span class="keyword">void</span> *val;</div><div class="line">        <span class="keyword">uint64_t</span> u64;</div><div class="line">        <span class="keyword">int64_t</span> s64;</div><div class="line">        <span class="keyword">double</span> d;</div><div class="line">    &#125; v;</div><div class="line">    <span class="keyword">struct</span> dictEntry *next; <span class="comment">// å•é“¾</span></div><div class="line">&#125; dictEntry;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dict &#123;</div><div class="line">    dictType *type; <span class="comment">// æŒ‡å®šç”¨æ¥æ“ä½œä¸åŒç±»å‹æ•°æ®çš„å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> *privdata; <span class="comment">// éœ€è¦ä¼ é€’ç»™æ“ä½œå‡½æ•°çš„ä¸€äº›æ•°æ®</span></div><div class="line">    dictht ht[<span class="number">2</span>]; <span class="comment">// å“ˆå¸Œè¡¨</span></div><div class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">// rehashçš„è¿›åº¦ï¼Œå¦‚æœæ²¡æœ‰åœ¨æ‰§è¡Œåˆ™æ˜¯-1</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iterators; <span class="comment">// æ­£åœ¨éå†çš„è¿­ä»£å™¨æ•°é‡</span></div><div class="line">&#125; dict;</div></pre></td></tr></table></figure>
<p>å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/01.png" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>å½“è´Ÿè½½å› å­è¾¾åˆ°ä¸€å®šé˜ˆå€¼å¼€å§‹æ‰©å®¹/ç¼©å®¹ï¼š<font color="red">é‡æ–°åˆ†é…dicthtå¹¶å¯¹å·²æœ‰æ•°æ®é‡æ–°è®¡ç®—å“ˆå¸Œ</font>ã€‚</p>
<p>åœ¨CRUDçš„è¿‡ç¨‹ä¸­ï¼ˆæˆ–è€…å®šæ—¶ï¼Ÿï¼‰æ‰§è¡Œrehashï¼Œæ¯æ¬¡å¤„ç†rehashidxå¯¹åº”çš„åˆ—è¡¨ï¼Œæ“ä½œå®ŒæˆårehashidxåŠ ä¸€ï¼ˆ<font color="red">æ¸è¿›å¼rehash</font>ï¼‰ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯é¿å…å‡ºç°é•¿å»¶è¿Ÿã€‚</p>
</blockquote>
<h3 id="intset"><a href="#intset" class="headerlink" title="intset"></a>intset</h3><p>ä¿å­˜ä¸é‡å¤çš„ã€<font color="red">æœ‰åºï¼ˆä»å°åˆ°å¤§ï¼‰</font>çš„æ•°å­—é›†åˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> intset &#123;</div><div class="line">    <span class="keyword">uint32_t</span> encoding;   <span class="comment">// ç±»å‹ï¼šint16/int32/int64</span></div><div class="line">    <span class="keyword">uint32_t</span> length;     <span class="comment">// é•¿åº¦</span></div><div class="line">    <span class="keyword">int8_t</span> contents[];   <span class="comment">// å†…å®¹</span></div><div class="line">&#125; intset;</div></pre></td></tr></table></figure>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ›´æ–°è¿‡ç¨‹ä¸­æ ¹æ®æ•°å­—çš„èŒƒå›´å†³å®šæ˜¯å¦éœ€è¦å‡çº§ï¼ˆencodingï¼‰ï¼Œä¸æ”¯æŒé™çº§ã€‚</p>
<p>æ’å…¥æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨å…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸ä¼šæ’å…¥ï¼›å¦åˆ™ï¼ŒæŠŠæ•°ç»„ä¸­çš„å…ƒç´ æŒªåŠ¨è…¾å‡ºæ¥ç©ºé—´æ¥å­˜æ”¾æ•°æ®ã€‚</p>
</blockquote>
<h3 id="ziplist"><a href="#ziplist" class="headerlink" title="ziplist"></a>ziplist</h3><p>ç”¨æ•°ç»„æ¥å®ç°<font color="red">åŒå‘é“¾è¡¨ï¼Œä¸ºäº†çœå†…å­˜å¿«ç–¯äº†</font>ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/02.png" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ ¹æ®encodingæ¥å†³å®šå­˜æ”¾çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚</p>
<p>æ ¹æ®previous_entry_lengthï¼ˆå‰é¢èŠ‚ç‚¹çš„å¤§å°ï¼‰æ¥å®ç°å‘éå†ã€‚</p>
<p>è™½ç„¶æŸ¥æ‰¾æ˜¯$O(N)$çš„å¤æ‚åº¦ï¼Œä½†æ˜¯æ•°ç»„ç›¸é‚»çš„æ•°æ®ä¼šåŠ è½½åˆ°é«˜é€Ÿç¼“å­˜ï¼Œæ‰€ä»¥é€Ÿåº¦å¹¶ä¸æ…¢ã€‚</p>
</blockquote>
<h3 id="quicklist"><a href="#quicklist" class="headerlink" title="quicklist"></a>quicklist</h3><p>é’ˆå¯¹LISTå’ŒZIPLISTçš„ç¼ºç‚¹å¼•å…¥ï¼ŒQUICKLIST = LIST + ZIPLISTï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/14.jpg" alt=""></p>
<p>ä½¿ç”¨QUICKLISTç®¡ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> quicklist &#123;</div><div class="line">    quicklistNode *head;          <span class="comment">// å¤´</span></div><div class="line">    quicklistNode *tail;          <span class="comment">// å°¾</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> count;          <span class="comment">// å…ƒç´ æ€»æ•°</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len;            <span class="comment">// ziplistæ€»æ•°</span></div><div class="line">    <span class="keyword">int</span> fill : <span class="number">16</span>;                <span class="comment">// ziplist é•¿åº¦ï¼Œè´Ÿæ•°æ—¶æ›´å¤§</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> compress : <span class="number">16</span>;   <span class="comment">// ä¸¤ç«¯ä¸å‹ç¼©çš„èŠ‚ç‚¹æ•°é‡</span></div><div class="line">&#125; quicklist;</div></pre></td></tr></table></figure>
<p>ç®¡ç†ZIPLISTçš„ç»“æ„ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> quicklistNode &#123;</div><div class="line">    <span class="keyword">struct</span> quicklistNode *prev;    <span class="comment">// å‰</span></div><div class="line">    <span class="keyword">struct</span> quicklistNode *next;    <span class="comment">// å</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl;             <span class="comment">// ziplist</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz;               <span class="comment">// ziplist size</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count : <span class="number">16</span>;       <span class="comment">// ziplist å…ƒç´ æ•°é‡</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> encoding : <span class="number">2</span>;     <span class="comment">// ç¼–ç æ–¹å¼ï¼š1ã€åŸç”Ÿï¼›2ã€LZFå‹ç¼©ï¼›</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> container : <span class="number">2</span>;    </div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> recompress : <span class="number">1</span>;   <span class="comment">// æ˜¯å¦å‹ç¼©</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> attempted_compress : <span class="number">1</span>; </div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extra : <span class="number">10</span>; </div><div class="line">&#125; quicklistNode;</div></pre></td></tr></table></figure>
<p>å‹ç¼©åçš„èŠ‚ç‚¹ç»“æ„ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> quicklistLZF &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz;               <span class="comment">// å­—èŠ‚æ•°</span></div><div class="line">    <span class="keyword">char</span> compressed[];</div><div class="line">&#125; quicklistLZF;</div></pre></td></tr></table></figure>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ›´æ–°æ“ä½œé‡‡ç”¨å…ˆåˆ é™¤å†æ’å…¥æ¥å®Œæˆã€‚</p>
</blockquote>
<h3 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h3><p>åœ¨REDIS 5.0.0å¼•å…¥çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ï¼Œæ ¸å¿ƒå…ƒç´ ï¼š</p>
<ul>
<li><code>æ¶ˆæ¯</code>ï¼šIDä¿è¯é€’å¢ä¸”å”¯ä¸€ï¼›</li>
<li><code>ç”Ÿäº§è€…</code></li>
<li><code>æ¶ˆè´¹è€…</code></li>
<li><code>æ¶ˆè´¹ç»„</code>ï¼šä¸€ä¸ªæ¶ˆæ¯åªéœ€è¦ä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œé¢ä¸€ä¸ªæ¶ˆè´¹ç»„æ¶ˆè´¹å³å¯ï¼›</li>
</ul>
<p>æ ¸å¿ƒçš„æ•°æ®ç»“æ„æœ‰ï¼š</p>
<ul>
<li><code>listpack</code>ï¼šå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œç”¨æ¥å­˜æ”¾å¤šä¸ªæ¶ˆæ¯ï¼›</li>
<li><code>rax</code>ï¼šå‹ç¼©å‰ç¼€æ ‘ï¼Œå¤©ç”Ÿæ’åºä¸”èƒ½å¿«é€Ÿæ£€ç´¢ï¼›</li>
</ul>
<p>æ•´ä½“å¦‚ä¸‹ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/00.png" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ ‡å¿—ä½åˆ é™¤ã€‚</p>
</blockquote>
<h2 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h2><p>å„ç§ç±»å‹å¯¹åº”çš„åº•å±‚ç»“æ„åœ¨ä¸Šé¢ï¼Œå‘½ä»¤çš„å®ç°åŸºæœ¬ä¹Ÿèƒ½çŒœåˆ°ï¼Œä¸»è¦æ˜¯åˆ—ä¸¾ç›¸å…³æŒ‡ä»¤ã€‚</p>
<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>set</code> key value [NX] [XX] [EX seconds] [PX milliseconds]</td>
<td>è®¾ç½®å­—ç¬¦ä¸²<br>NXï¼šä¸å­˜åœ¨æ—¶è®¾ç½®<br>XXï¼šå­˜åœ¨æ—¶è®¾ç½®<br>EXï¼šè¶…æ—¶ç§’æ•°<br>PXï¼šè¶…æ—¶æ¯«ç§’æ•°</td>
</tr>
<tr>
<td><code>setnx</code> key value</td>
<td>å½“KEYä¸å­˜åœ¨æ—¶è®¾ç½®</td>
</tr>
<tr>
<td><code>setex</code> key seconds value</td>
<td>åŒæ—¶è®¾ç½®ç§’çº§è¿‡æœŸæ—¶é—´</td>
</tr>
<tr>
<td><code>psetex</code> key milliseconds value</td>
<td>åŒæ—¶è®¾ç½®æ¯«ç§’çº§è¿‡æœŸæ—¶é—´</td>
</tr>
<tr>
<td><code>mset</code> key value [key value â€¦]</td>
<td>æ‰¹é‡è®¾ç½®</td>
</tr>
<tr>
<td><code>msetnx</code> key value [key value â€¦]</td>
<td>å½“æ‰€æœ‰KEYéƒ½ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®</td>
</tr>
<tr>
<td><code>append</code> key value</td>
<td>å°¾éƒ¨è¿½åŠ </td>
</tr>
<tr>
<td><code>setrange</code> key offset value</td>
<td>æ ¹æ®åç§»é‡è®¾ç½®éƒ¨åˆ†å­ä¸²</td>
</tr>
<tr>
<td><code>incrby</code> key increment &amp; <code>decrby</code> key decrement</td>
<td>åŠ å€¼ &amp; å‡å€¼</td>
</tr>
<tr>
<td><code>incr</code> key &amp; <code>decr</code> key</td>
<td>åŠ ä¸€ &amp; å‡ä¸€</td>
</tr>
<tr>
<td><code>incrbyfloat</code> key increment</td>
<td>åŠ å€¼ï¼ˆæµ®ç‚¹æ•°ï¼‰</td>
</tr>
<tr>
<td><code>get</code> key</td>
<td>è·å–KEY</td>
</tr>
<tr>
<td><code>getset</code> key value</td>
<td>è®¾ç½®æ–°å€¼ã€è¿”å›è€å€¼</td>
</tr>
<tr>
<td><code>getrange</code> key start end</td>
<td>è·å–å­ä¸²</td>
</tr>
<tr>
<td><code>strlen</code> key</td>
<td>è·å–é•¿åº¦</td>
</tr>
<tr>
<td><code>mget</code> key [key â€¦]</td>
<td>æ‰¹é‡è·å–</td>
</tr>
<tr>
<td><code>setbit</code> key offset value</td>
<td>äºŒè¿›åˆ¶ä½è®¾ç½®ä¸ºä¸€</td>
</tr>
<tr>
<td><code>getbit</code> key offset</td>
<td>è·å–äºŒè¿›åˆ¶ä½çš„å€¼</td>
</tr>
<tr>
<td><code>bitpos</code> key bit [start [end]]</td>
<td>è·å–<font color="red">å­—èŠ‚èŒƒå›´</font>çš„ç¬¬ä¸€ä¸ªbitçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td><code>bitcount</code> key [start] [end]</td>
<td>è·å–<font color="red">å­—èŠ‚èŒƒå›´</font>çš„1çš„ä¸ªæ•°</td>
</tr>
<tr>
<td><code>bitop</code> op_name target_key key [key]</td>
<td>å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªKEYæ“ä½œå¹¶ä¿å­˜åˆ°æ–°KEYä¸Š<br>AND<br>OR<br>NOT<br>XOR</td>
</tr>
<tr>
<td><code>bitfield</code> key [get type offset] [set type offset value] [incrby type offset ] [overflow WRAP / SAT / FAIL]</td>
<td>ä½œä¸ºäºŒè¿›åˆ¶æ•°æ®è¿›è¡Œæ“ä½œ</td>
</tr>
</tbody>
</table>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hset</code> key field value</td>
<td>è¦†ç›–è®¾ç½®</td>
</tr>
<tr>
<td><code>hmset</code> key field value [field value â€¦]</td>
<td>æ‰¹é‡è®¾ç½®</td>
</tr>
<tr>
<td><code>hsetnx</code> key field value</td>
<td>ä¸å­˜åœ¨æ—¶è®¾ç½®</td>
</tr>
<tr>
<td><code>hexists</code> key field</td>
<td>æ˜¯å¦å­˜åœ¨</td>
</tr>
<tr>
<td><code>hget</code> key field</td>
<td>è·å–</td>
</tr>
<tr>
<td><code>hmget</code> key field [field â€¦]</td>
<td>æ‰¹é‡è·å–</td>
</tr>
<tr>
<td><code>hkeys</code> key</td>
<td>è·å–æ‰€æœ‰FIELD</td>
</tr>
<tr>
<td><code>hvals</code> key</td>
<td>è·å–æ‰€æœ‰VALUE</td>
</tr>
<tr>
<td><code>hgetall</code> key</td>
<td>è·å–æ‰€æœ‰FIELD + VALUE</td>
</tr>
<tr>
<td><code>hlen</code> key</td>
<td>è·å–FIELDä¸ªæ•°</td>
</tr>
<tr>
<td><code>hscan</code> key cursor [MATCH pattern] [COUNT count]</td>
<td>æ¸è¿›å¼éå†ï¼Œæ”¯æŒåŒ¹é…ï¼ˆcountä¸ä¸€å®šå‡†ï¼‰</td>
</tr>
<tr>
<td><code>hdel</code> key field [field â€¦]</td>
<td>åˆ é™¤</td>
</tr>
<tr>
<td><code>hincrby</code> key field increment</td>
<td>è‡ªå¢</td>
</tr>
<tr>
<td><code>hincrbyfloat</code> key field increment</td>
<td>è‡ªå¢æµ®ç‚¹æ•°</td>
</tr>
</tbody>
</table>
<h3 id="list-1"><a href="#list-1" class="headerlink" title="list"></a>list</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lpush</code> key value [value â€¦] <br>â€”<br><code>lpushx</code>ï¼šKEYä¸å­˜åœ¨æ—¶ä¸æ“ä½œ<br><code>rpush</code>ï¼šå°¾éƒ¨æ’å…¥<br><code>rpushx</code>ï¼šå°¾éƒ¨æ’å…¥ï¼ŒKEYä¸å­˜åœ¨æ—¶ä¸æ“ä½œ</td>
<td>å¤´éƒ¨æ’å…¥</td>
</tr>
<tr>
<td><code>lpop</code> key<br>â€”<br><code>rpop</code>ï¼šå°¾éƒ¨å¼¹å‡º</td>
<td>å¤´éƒ¨å¼¹å‡º</td>
</tr>
<tr>
<td><code>blpop</code> key [key â€¦] timeout<br>â€”<br><code>brpop</code>ï¼šå°¾éƒ¨é˜»å¡å¼¹å‡º</td>
<td>å¤´éƒ¨å¼¹å‡ºï¼Œåˆ—è¡¨ä¸ºç©ºåˆ™ç­‰å¾…</td>
</tr>
<tr>
<td><code>lindex</code> key index</td>
<td>æ ¹æ®ä¸‹æ ‡è·å–å…ƒç´ </td>
</tr>
<tr>
<td><code>lrange</code> key start end</td>
<td>æ ¹æ®èŒƒå›´è·å–å…ƒç´ </td>
</tr>
<tr>
<td><code>llen</code> key</td>
<td>è·å–åˆ—è¡¨é•¿åº¦</td>
</tr>
<tr>
<td><code>lset</code> key index value</td>
<td>è®¾ç½®æŒ‡å®šç´¢å¼•ä½ç½®çš„å€¼</td>
</tr>
<tr>
<td><code>linsert</code> key before / after pivot value</td>
<td>åœ¨pivotçš„å‰åæ’å…¥æ–°å€¼</td>
</tr>
<tr>
<td><code>lrem</code> key count value</td>
<td>ç§»é™¤æŒ‡å®šæ•°é‡çš„value</td>
</tr>
<tr>
<td><code>ltrim</code> key start stop</td>
<td>ä¿ç•™æŒ‡å®šèŒƒå›´å…ƒç´ ï¼Œå…¶ä½™åˆ é™¤</td>
</tr>
<tr>
<td><code>brpoplpush</code> source destination timeout</td>
<td>é˜»å¡åœ°ä»sourceå°¾éƒ¨ç§»åŠ¨åˆ°destinationå¤´éƒ¨</td>
</tr>
<tr>
<td><code>rpoplpush</code> source destination timeout</td>
<td>éé˜»å¡ç§»åŠ¨</td>
</tr>
</tbody>
</table>
<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sadd</code> key member [member â€¦]</td>
<td>æ·»åŠ ï¼Œè¿”å›æˆåŠŸä¸ªæ•°</td>
</tr>
<tr>
<td><code>srem</code> key member [member â€¦]</td>
<td>ç§»é™¤</td>
</tr>
<tr>
<td><code>spop</code> key [count]</td>
<td>éšæœºç§»é™¤å¹¶è¿”å›</td>
</tr>
<tr>
<td><code>srandmember</code> key [count]</td>
<td>éšæœºè¿”å›</td>
</tr>
<tr>
<td><code>smembers</code> key</td>
<td>è¿”å›æ‰€æœ‰å…ƒç´ </td>
</tr>
<tr>
<td><code>sismember</code> key member</td>
<td>åˆ¤æ–­æ˜¯å¦å­˜åœ¨</td>
</tr>
<tr>
<td><code>smove</code> source destination member</td>
<td>å°†memberä»sourceç§»åŠ¨åˆ°destination</td>
</tr>
<tr>
<td><code>scard</code> key</td>
<td>å…ƒç´ ä¸ªæ•°</td>
</tr>
<tr>
<td><code>sscan</code> key cursor [match pattern] [count count]</td>
<td>å¢é‡éå†ï¼ˆæ ¹æ®è¿”å›å€¼ç»§ç»­éå†ï¼‰</td>
</tr>
<tr>
<td><code>sinter</code> key [key â€¦]</td>
<td>äº¤é›†ï¼ˆæ‰¾åˆ°æœ€å°çš„é›†åˆå¼€å§‹ä¾æ¬¡æ ¡éªŒå…ƒç´ ï¼‰</td>
</tr>
<tr>
<td><code>sinterstore</code> destination key [key â€¦]</td>
<td>è®¡ç®—äº¤é›†åä¿å­˜åˆ°destination</td>
</tr>
<tr>
<td><code>sunion</code> key [key â€¦]</td>
<td>å¹¶é›†</td>
</tr>
<tr>
<td><code>sdiff</code> key [key â€¦]</td>
<td>å·®é›†ï¼ˆæ‰¾åˆ°æœ€å°çš„ï¼Œç„¶åä¾æ¬¡æ‰¾åˆ°å…¶ä»–é›†åˆé‡Œé¢æ²¡æœ‰çš„ï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>zadd</code> key [NX] [XX] [CH] [INCR] score member [score member]</td>
<td>å¢åŠ å…ƒç´ å’Œåˆ†å€¼</td>
</tr>
<tr>
<td><code>zrem</code> key member [member â€¦]</td>
<td>ç§»é™¤</td>
</tr>
<tr>
<td><code>zcard</code> key</td>
<td>å…ƒç´ ä¸ªæ•°</td>
</tr>
<tr>
<td><code>zcount</code> key min max</td>
<td>èŒƒå›´å†…å…ƒç´ æ•°é‡</td>
</tr>
<tr>
<td><code>zincrby</code> key increment member</td>
<td>å…ƒç´ memberçš„åˆ†å€¼å¢åŠ increment</td>
</tr>
<tr>
<td><code>zrank</code> key member</td>
<td>æ’åï¼ˆä»å°åˆ°å¤§ï¼‰</td>
</tr>
<tr>
<td><code>zrevrank</code> key member</td>
<td>æ’åï¼ˆä»å¤§åˆ°å°ï¼‰</td>
</tr>
<tr>
<td><code>zscan</code> key cursor [MATCH pattern] [COUNT count]</td>
<td>éå†</td>
</tr>
<tr>
<td><code>zscore</code> key member</td>
<td>è·å–åˆ†å€¼</td>
</tr>
<tr>
<td><code>zrange</code> key start stop [WITHSCORES]</td>
<td>é€’å¢é¡ºåºè·å–åŒºé—´å…ƒç´ </td>
</tr>
<tr>
<td><code>zrevrange</code> key start stop [WITHSCORES]</td>
<td>é€’å‡é¡ºåºè·å–åŒºé—´å…ƒç´ </td>
</tr>
<tr>
<td><code>zrangebyscore</code> key min max [WITHSCORES] [LIMIT offset count]</td>
<td>é€’å¢é¡ºåºè·å–åˆ†å€¼èŒƒå›´å†…å…ƒç´ </td>
</tr>
<tr>
<td><code>zrevrangebyscore</code> key min max [WITHSCORES] [LIMIT offset count]</td>
<td>é€’å‡é¡ºåºè·å–åˆ†å€¼èŒƒå›´å†…å…ƒç´ </td>
</tr>
<tr>
<td><code>zlexcount</code> key min max</td>
<td>åˆ†å€¼èŒƒå›´å†…å…ƒç´ ä¸ªæ•°</td>
</tr>
<tr>
<td><code>zremrangebyrank</code> key start stop</td>
<td>ç§»é™¤æ’ååŒºé—´å†…å…ƒç´ </td>
</tr>
<tr>
<td><code>zremrangebyscore</code> key min max</td>
<td>ç§»é™¤åˆ†å€¼åŒºé—´å†…å…ƒç´ </td>
</tr>
<tr>
<td><code>zremrangebylex</code> key min max</td>
<td>ç§»é™¤å­—å…¸åºåŒºé—´å†…å…ƒç´ </td>
</tr>
<tr>
<td><code>zunionstore</code> destination numkeys key [key â€¦] [WEIGHTS weight [weight â€¦]] [AGGREGATE SUM / MIN / MAX]</td>
<td>å¹¶é›†</td>
</tr>
<tr>
<td><code>zinterstore</code> destination numkeys key [key â€¦] [WEIGHTS weight [weight â€¦]] [AGGREGATE SUM / MIN / MAX]</td>
<td>äº¤é›†</td>
</tr>
</tbody>
</table>
<h1 id="é€šç”¨å‘½ä»¤"><a href="#é€šç”¨å‘½ä»¤" class="headerlink" title="é€šç”¨å‘½ä»¤"></a>é€šç”¨å‘½ä»¤</h1><ul>
<li><code>object</code> subcommand [arguments [arguments]]<ul>
<li><code>refcount</code>ï¼šå¼•ç”¨æ•°ï¼›</li>
<li><code>encoding</code>ï¼šå†…éƒ¨å­˜å‚¨ç¼–ç æ–¹å¼ï¼›</li>
<li><code>idletime</code>ï¼šç©ºé—²æ—¶é—´ï¼›</li>
<li><code>freq</code>ï¼šè®¿é—®é¢‘æ¬¡$log$ï¼Œåœ¨ä½¿ç”¨LFUä¾§ç‡æ—¶æœ‰ç”¨ï¼›</li>
</ul>
</li>
<li><code>type key</code>ï¼šç±»å‹ï¼›</li>
<li><code>ttl key</code>ï¼šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼›</li>
<li><code>expire key seconds</code>ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼›</li>
<li><code>persist key</code>ï¼šåˆ é™¤è¿‡æœŸæ—¶é—´ï¼›</li>
<li><code>rename key new_key</code>ï¼šé‡å‘½åï¼›</li>
<li><code>touch key [key]</code>ï¼šæ›´æ–°è®¿é—®æ—¶é—´ï¼Œé¿å…è¢«æ·˜æ±°ï¼›</li>
<li><code>exists key [key]</code>ï¼šæ£€æŸ¥æ˜¯å¦å­˜å‚¨ï¼Œè¿”å›å­˜åœ¨çš„æ•°é‡ï¼›</li>
<li><code>key pattern</code>ï¼šæ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ä¸€æ¬¡æ€§è¿”å›ï¼Œæ•°é‡å¾ˆå¤§æœ‰å¯èƒ½é˜»å¡æœåŠ¡å™¨ï¼›</li>
<li><code>scan cursor [MATCH pattern] [COUNT count]</code>ï¼šé—´æ–­æ€§éå†ï¼›</li>
<li><code>randomkey</code>ï¼šéšæœºï¼›</li>
<li><code>del key [key]</code>ï¼šåˆ é™¤ï¼›</li>
<li><code>unlink key [key]</code>ï¼šåˆ é™¤ï¼Œå¦‚æœæ•°æ®å¤ªå¤§ä¼šå¼‚æ­¥æ‰§è¡Œï¼›</li>
<li><code>dump key</code>ï¼šåºåˆ—åŒ–ï¼›</li>
<li><code>restore key ttl serialized-value [replace]</code>ï¼šååºåˆ—åŒ–åä¸KEYå…³è”ï¼›</li>
<li><code>move key db</code>ï¼šç§»åŠ¨åˆ°å¦ä¸€ä¸ªDBï¼›</li>
<li><code>migrate</code>ï¼šç§»åŠ¨åˆ°å¦ä¸€ä¸ªå®ä¾‹ï¼›</li>
<li><code>sort</code>ï¼šé’ˆå¯¹æŒ‡å®šçš„KEYæ’åºï¼›</li>
</ul>
<h1 id="åŸºç¡€é€»è¾‘æœºåˆ¶"><a href="#åŸºç¡€é€»è¾‘æœºåˆ¶" class="headerlink" title="åŸºç¡€é€»è¾‘æœºåˆ¶"></a>åŸºç¡€é€»è¾‘æœºåˆ¶</h1><h2 id="é˜»å¡"><a href="#é˜»å¡" class="headerlink" title="é˜»å¡"></a>é˜»å¡</h2><p>åœ¨ç”¨BRPOPæ—¶ï¼Œå¦‚æœKEYä¸ºç©ºåˆ™ä¼šé˜»å¡ç­‰å¾…ï¼Œæ­¤æ—¶ä¼šåœ¨redisDbä¸­ç»´æŠ¤æ‰€æœ‰é˜»å¡çš„KEYï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> redisDb &#123;</div><div class="line">    ...</div><div class="line">    dict *blocking_keys;</div><div class="line">    dict *ready_keys;</div><div class="line">    ...</div><div class="line">&#125; redisDb;</div></pre></td></tr></table></figure>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æ¯ä¸ªKEYå¯èƒ½åŒæ—¶ä¼šé˜»å¡å¤šä¸ªå®¢æˆ·ç«¯ï¼Œç”¨åˆ—è¡¨ç®¡ç†ã€‚</p>
</blockquote>
<p>å½“æ‰§è¡Œåˆ°PUSHå‘½ä»¤æ—¶å¦‚æœå‘ç°æœ‰è¢«KEYé˜»å¡äº†ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°ready_keysä¸­ï¼š</p>
<blockquote>
<p>åœ¨PUSHæŒ‡ä»¤å®Œæˆåæ£€æŸ¥ready_keysï¼Œå”¤é†’æ‰€æœ‰éœ€è¦å”¤é†’çš„å®¢æˆ·ç«¯ï¼Œéƒ¨åˆ†å®¢æˆ·ç«¯ä¹Ÿå¯èƒ½å·²ç»è¶…æ—¶äº†ã€‚</p>
</blockquote>
<h2 id="äº‹ä»¶è½®è¯¢"><a href="#äº‹ä»¶è½®è¯¢" class="headerlink" title="äº‹ä»¶è½®è¯¢"></a>äº‹ä»¶è½®è¯¢</h2><p>åœ¨REDISä¸­å®ç°äº†ä¸€å¥—äº‹ä»¶æœºåˆ¶ï¼ŒåŒ…å«æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ï¼Œæ•´ä½“çš„ç»“æ„ä¸ºï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/15.png" alt=""></p>
<p>åœ¨ç¼–è¯‘æ—¶ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿçš„ç‰¹æ€§æ¥é€‰æ‹©æ–‡ä»¶äº‹ä»¶ç­‰å¾…çš„æ–¹å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_EVPORT</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ae_evport.c"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_EPOLL</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ae_epoll.c"</span></span></div><div class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_KQUEUE</span></div><div class="line">        <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ae_kqueue.c"</span></span></div><div class="line">        <span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ae_select.c"</span></span></div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p>å®šä¹‰ç›¸åŒçš„æ¥å£æ¥å¯¹ä¸åŒçš„å®ç°è¿›è¡Œå°è£…ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">aeApiCreate</span><span class="params">(aeEventLoop *eventLoop)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">aeApiAddEvent</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> fd, <span class="keyword">int</span> mask)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">aeApiDelEvent</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> fd, <span class="keyword">int</span> delmask)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">aeApiPoll</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">struct</span> timeval *tvp)</span></span>;</div></pre></td></tr></table></figure>
<p>æ—¶é—´äº‹ä»¶ä¼šæ¯”è¾ƒç®€å•ï¼Œæ¯æ¬¡æ‰¾åˆ°æœ€æ–°åˆ°è¾¾çš„äº‹ä»¶ï¼Œå¦‚æœåˆ°äº†å°±æ‰§è¡Œï¼Œè¿˜æ²¡åˆ°å°±ç»§ç»­ç­‰ç€ã€‚</p>
<h2 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h2><p>å‘½ä»¤ï¼š</p>
<ul>
<li><code>multi</code>ï¼šå¼€å¯äº‹åŠ¡ï¼›</li>
<li><code>exec</code>ï¼šæ‰§è¡Œï¼›</li>
<li><code>discard</code>ï¼šæ”¾å¼ƒï¼›</li>
<li><code>watch</code>ï¼šä¹è§‚é”æœºåˆ¶ï¼Œå½“å¯¹åº”çš„KEYæœªä¿®æ”¹æ—¶æ‰ä¼šæäº¤äº‹åŠ¡ï¼›</li>
<li><code>unwatch</code>ï¼šå–æ¶ˆç›‘å¬ï¼›</li>
</ul>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>æŒ‡ä»¤è¢«ä¿å­˜åœ¨clientä¸­ã€‚</p>
<p>å½“watchæ—¶ï¼Œä¼šåœ¨clientä¿å­˜ç›‘å¬çš„KEYï¼ŒåŒæ—¶åœ¨dbä¸Šç»´æŠ¤æœªä¿®æ”¹çš„KEYï¼ˆå‘ç”Ÿå†™æ“ä½œæ—¶ç§»é™¤ï¼‰ã€‚</p>
</blockquote>
<h2 id="å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œæµç¨‹"><a href="#å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œæµç¨‹" class="headerlink" title="å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œæµç¨‹"></a>å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œæµç¨‹</h2><p>åœ¨å®¢æˆ·ç«¯è¿æ¥åˆ°REDISæœåŠ¡å™¨çš„å¤„ç†æµç¨‹ä¸ºï¼š</p>
<ul>
<li>ç›‘å¬ç«¯å£ï¼›</li>
<li>å½“æœ‰è¿æ¥äº‹ä»¶æ—¶ï¼Œåˆ›å»ºç›¸åº”çš„æ•°æ®ç»“æ„ï¼Œå¹¶å¼€å§‹ç›‘å¬è¯»äº‹ä»¶ï¼›</li>
</ul>
<p>ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç›‘å¬ç«¯å£ï¼šIPV4ã€IPV6</span></div><div class="line">    <span class="keyword">if</span> (server.port != <span class="number">0</span> &amp;&amp;</div><div class="line">        listenToPort(server.port,server.ipfd,&amp;server.ipfd_count) == C_ERR)</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">// æ³¨å†Œäº‹ä»¶å¤„ç†æ–¹æ³•ï¼š acceptTcpHandler</span></div><div class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</div><div class="line">        <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</div><div class="line">            acceptTcpHandler,<span class="literal">NULL</span>) == AE_ERR)</div><div class="line">            &#123;</div><div class="line">                serverPanic(</div><div class="line">                    <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">acceptTcpHandler</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span>(max--) &#123;</div><div class="line">        <span class="comment">// ACCEPTè·å–IPç­‰ä¿¡æ¯</span></div><div class="line">        cfd = anetTcpAccept(server.neterr, fd, cip, <span class="keyword">sizeof</span>(cip), &amp;cport);</div><div class="line">        <span class="keyword">if</span> (cfd == ANET_ERR) &#123;</div><div class="line">            <span class="keyword">if</span> (errno != EWOULDBLOCK)</div><div class="line">                serverLog(LL_WARNING,</div><div class="line">                    <span class="string">"Accepting client connection: %s"</span>, server.neterr);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        acceptCommonHandler(cfd,<span class="number">0</span>,cip);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">acceptCommonHandler</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> flags, <span class="keyword">char</span> *ip)</span> </span>&#123;</div><div class="line">    client *c;</div><div class="line">    <span class="keyword">if</span> ((c = createClient(fd)) == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">client *<span class="title">createClient</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</div><div class="line">    <span class="comment">// åˆ›å»ºCLIENT</span></div><div class="line">    client *c = zmalloc(<span class="keyword">sizeof</span>(client));</div><div class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</div><div class="line">        <span class="comment">// è®¾ç½®éé˜»å¡</span></div><div class="line">        anetNonBlock(<span class="literal">NULL</span>,fd);</div><div class="line">        <span class="comment">// è®¾ç½®NO_DELAY</span></div><div class="line">        anetEnableTcpNoDelay(<span class="literal">NULL</span>,fd);</div><div class="line">        <span class="keyword">if</span> (server.tcpkeepalive)</div><div class="line">            anetKeepAlive(<span class="literal">NULL</span>,fd,server.tcpkeepalive);</div><div class="line">        <span class="comment">// æ·»åŠ äº‹ä»¶ç›‘æ§</span></div><div class="line">        <span class="keyword">if</span> (aeCreateFileEvent(server.el,fd,AE_READABLE,</div><div class="line">            readQueryFromClient, c) == AE_ERR)</div><div class="line">        &#123;</div><div class="line">            close(fd);</div><div class="line">            zfree(c);</div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å®¢æˆ·ç«¯å‘é€å‘½ä»¤ï¼Œæ‰§è¡Œæµç¨‹ä¸ºï¼š</p>
<ul>
<li>è§¦å‘äº‹ä»¶ï¼Œè¯»å–å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ï¼›</li>
<li>æ‰§è¡Œå‘½ä»¤æ³¨å†Œå¥½çš„å›è°ƒå‡½æ•°ï¼›</li>
<li>æ‰§è¡ŒæˆåŠŸåï¼Œå°†ç»“æœå†™åˆ°å®¢æˆ·ç«¯å¯¹åº”çš„ç¼“å­˜ä¸Šï¼Œå®¢æˆ·ç«¯ä¹ŸæŒ‚åˆ°ç­‰å¾…å†™å‡ºçš„é“¾è¡¨ä¸Šï¼›</li>
</ul>
<p>ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">readQueryFromClient</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</div><div class="line">    readlen = PROTO_IOBUF_LEN;</div><div class="line">    <span class="comment">// è¯»å–å®¢æˆ·ç«¯å‘½ä»¤</span></div><div class="line">    nread = read(fd, c-&gt;querybuf+qblen, readlen);</div><div class="line">    <span class="comment">// å¤„ç†å‘½ä»¤</span></div><div class="line">    processInputBufferAndReplicate(c);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">processInputBufferAndReplicate</span><span class="params">(client *c)</span> </span>&#123;</div><div class="line">    processInputBuffer(c);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">processInputBuffer</span><span class="params">(client *c)</span> </span>&#123;</div><div class="line">    processCommand(c);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">processCommand</span><span class="params">(client *c)</span> </span>&#123;</div><div class="line">    call(c,CMD_CALL_FULL);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">call</span><span class="params">(client *c, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">    c-&gt;cmd-&gt;proc(c);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰¾åˆ°å‘½ä»¤å¤„ç†å‡½æ•°åï¼Œæ‰§è¡Œå®Œæˆä¼šè°ƒç”¨addReplyæŠŠæ•°æ®æ·»åŠ åˆ°è¾“å‡ºç¼“å­˜åŒºã€‚æœ€åï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œä¼šæ£€æŸ¥å¹¶æŠŠæ•°æ®ç¼“å­˜å†™ç»™å®¢æˆ·ç«¯ï¼š</p>
<ul>
<li>å¯¹äºè¾“å‡ºç¼“å­˜åŒºéç©ºçš„å®¢æˆ·ç«¯ï¼Œç›‘å¬å¯å†™äº‹ä»¶ï¼›</li>
<li>æ¥åˆ°å¯å†™äº‹ä»¶ååˆ·æ•°æ®ï¼›</li>
</ul>
<p>ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">aeMain</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</div><div class="line">    eventLoop-&gt;stop = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (!eventLoop-&gt;stop) &#123;</div><div class="line">        <span class="keyword">if</span> (eventLoop-&gt;beforesleep != <span class="literal">NULL</span>)</div><div class="line">            eventLoop-&gt;beforesleep(eventLoop);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">beforeSleep</span><span class="params">(<span class="keyword">struct</span> aeEventLoop *eventLoop)</span> </span>&#123;</div><div class="line">    handleClientsWithPendingWrites();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">handleClientsWithPendingWrites</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> processed = listLength(server.clients_pending_write);</div><div class="line">    listRewind(server.clients_pending_write,&amp;li);</div><div class="line">    </div><div class="line">    <span class="comment">// éå†éœ€è¦è¾“å‡ºçš„å®¢æˆ·ç«¯</span></div><div class="line">    <span class="keyword">while</span>((ln = listNext(&amp;li))) &#123;</div><div class="line">        <span class="comment">// åˆ·æ•°æ®</span></div><div class="line">        <span class="keyword">if</span> (writeToClient(c-&gt;fd,c,<span class="number">0</span>) == C_ERR) <span class="keyword">continue</span>;</div><div class="line">        <span class="comment">// å¦‚æœè¿˜æœ‰æ²¡å†™å®Œçš„æ•°æ®ï¼Œåˆ™ç»§ç»­åˆ·</span></div><div class="line">        <span class="keyword">if</span> (clientHasPendingReplies(c)) &#123;</div><div class="line">            <span class="keyword">int</span> ae_flags = AE_WRITABLE;</div><div class="line">            <span class="comment">// æ³¨å†Œå¯å†™äº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œç»§ç»­åˆ·æ•°æ®</span></div><div class="line">            <span class="keyword">if</span> (aeCreateFileEvent(server.el, c-&gt;fd, ae_flags,</div><div class="line">                sendReplyToClient, c) == AE_ERR)</div><div class="line">            &#123;</div><div class="line">                    freeClientAsync(c);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> processed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="æ·˜æ±°"><a href="#æ·˜æ±°" class="headerlink" title="æ·˜æ±°"></a>æ·˜æ±°</h1><p>åœ¨å†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™ä¼šè€ƒè™‘åˆ é™¤éƒ¨åˆ†æ•°æ®ï¼Œç›¸å…³é…ç½®æœ‰ï¼š</p>
<ul>
<li><code>maxmemory</code>ï¼šå†…å­˜é™åˆ¶ï¼Œåœ¨è¾¾åˆ°é™åˆ¶æ—¶å¯åŠ¨æ·˜æ±°æœºåˆ¶ï¼›</li>
<li><code>maxmemory_policy</code>ï¼šæ·˜æ±°ç­–ç•¥ï¼›</li>
<li><code>maxmemory_samples</code>ï¼šéšæœºå–æ ·ç²¾åº¦ï¼›</li>
</ul>
<p>ç­–ç•¥ï¼š</p>
<ul>
<li><code>expires</code>ï¼šä»æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„é‡Œé¢æŒ‘ï¼ˆå¯èƒ½æ— æ³•æ·˜æ±°å‡ºè¶³å¤Ÿçš„ç©ºé—´ï¼‰ï¼›<ul>
<li><code>volatile-lru</code></li>
<li><code>volatile-ttl</code></li>
<li><code>volatile-lfu</code></li>
<li><code>volatile-random</code></li>
</ul>
</li>
<li><code>dict</code>ï¼šä»æ‰€æœ‰é‡Œé¢æŒ‘ï¼›<ul>
<li><code>allkeys-lru</code></li>
<li><code>allkeys-lfu</code></li>
<li><code>allkeys-random</code></li>
</ul>
</li>
<li><code>noeviction</code>ï¼šä¸æ·˜æ±°ï¼ˆé»˜è®¤å€¼ï¼‰ï¼›</li>
</ul>
<p>Redisåœ¨è®¿é—®æ•°æ®æ—¶ä¼šé€šè¿‡lookupKeyæŸ¥æ‰¾ï¼Œäºæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å¯ä»¥ç»Ÿä¸€è®¾ç½®robj-&gt;lruå€¼ï¼Œä½œä¸ºåç»­æ·˜æ±°çš„ä¾æ®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">robj *<span class="title">lookupKey</span><span class="params">(redisDb *db, robj *key, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">    dictEntry *de = dictFind(db-&gt;dict,key-&gt;ptr);</div><div class="line">    <span class="keyword">if</span> (de) &#123;</div><div class="line">        robj *val = dictGetVal(de);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (server.rdb_child_pid == <span class="number">-1</span> &amp;&amp; server.aof_child_pid == <span class="number">-1</span> &amp;&amp; !(flags &amp; LOOKUP_NOTOUCH))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU) &#123;</div><div class="line">                updateLFU(val);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                val-&gt;lru = LRU_CLOCK();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateLFU</span><span class="params">(robj *val)</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> counter = LFUDecrAndReturn(val);</div><div class="line">    counter = LFULogIncr(counter);</div><div class="line">    val-&gt;lru = (LFUGetTimeInMinutes()&lt;&lt;<span class="number">8</span>) | counter;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…·ä½“æ‰§è¡Œç­›é€‰å’Œé‡Šæ”¾åœ¨evict.c/freeMemoryIfNeededæ–¹æ³•å®Œæˆï¼Œæ€è·¯æ˜¯ï¼š</p>
<blockquote>
<p>æå‡ºä¸€æ‰¹æ•°æ®ï¼Œä»æ•°æ®ä¸­æ·˜æ±°ä¸€éƒ¨åˆ†æ•°æ®ï¼Œä»å…¨å±€æ¥çœ‹ä¸ä¸€å®šæ˜¯éœ€è¦æ·˜æ±°çš„ï¼Œ<font color="red">å¹¶éæœ€ä¼˜è§£</font>ã€‚</p>
</blockquote>
<h1 id="è¿‡æœŸ"><a href="#è¿‡æœŸ" class="headerlink" title="è¿‡æœŸ"></a>è¿‡æœŸ</h1><p>åœ¨åˆ°è¾¾KEYè®¾ç½®çš„è¿‡æœŸæ—¶é—´åï¼Œæ•°æ®å¹¶ä¸æ˜¯é©¬ä¸Šå°±è¢«åˆ é™¤äº†ï¼Œè€Œæ˜¯é€šè¿‡ä¸€äº›æœºåˆ¶æ¥å¤„ç†ï¼š</p>
<ul>
<li>åœ¨è¯»å†™KEYçš„æ—¶å€™åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶åˆ™åˆ é™¤ï¼›</li>
<li>å®šæœŸåˆ é™¤ï¼›<ul>
<li>å®ç°åœ¨expire/activeExpireCycleæ–¹æ³•ä¸­ï¼›</li>
<li>æ¯æ¬¡éšæœºå°è¯•ä¸€å®šæ¬¡æ•°çš„db-&gt;expiresä¸­çš„æ•°æ®ï¼Œéœ€è¦æ§åˆ¶æ—¶é—´ï¼Œä¸èƒ½å½±å“æ­£å¸¸è¯»å†™ï¼›</li>
</ul>
</li>
<li>å†…å­˜ä¸è¶³æ—¶åˆ é™¤ï¼ˆæ·˜æ±°ï¼Œç•¥ï¼‰ï¼›</li>
</ul>
<h1 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h1><p>é…ç½®ï¼š</p>
<ul>
<li><code>save 900 1</code>ï¼š900ç§’è‡³å°‘æœ‰1æ¬¡å†™å…¥åˆ™è§¦å‘ç”Ÿæˆå¿«ç…§ï¼›</li>
<li><code>dbfilename dump.rdb</code>ï¼šæ–‡ä»¶åï¼›</li>
<li><code>dir /home/work/app/redis/data/</code>ï¼šæ–‡ä»¶ä¿å­˜è·¯å¾„ï¼›</li>
<li><code>stop-writes-on-bgsave-error yes</code>ï¼šæŒä¹…åŒ–å‡ºé”™æ—¶ä¸»è¿›ç¨‹æ˜¯å¦åœæ­¢å†™å…¥ï¼›</li>
<li><code>rdbcompression yes</code>ï¼šæ˜¯å¦å‹ç¼©ï¼ˆå…³æ‰å¯ä»¥èŠ‚çœCPUğŸ¤”ï¼‰ï¼›</li>
<li><code>rdbchecksum yes</code>ï¼šå¯¼å…¥æ—¶æ˜¯å¦æ£€æŸ¥ï¼›</li>
<li><code>appendonly yes</code>ï¼šæ˜¯å¦å¼€å¯AOFï¼›</li>
<li><code>appendfilename &quot;appendonly.aof&quot;</code>ï¼šæ–‡ä»¶åï¼›</li>
<li><code>appendfsync</code>ï¼šåŒæ­¥æ–¹å¼ï¼ˆåˆ·ç›˜ï¼‰<ul>
<li><code>always</code>ï¼šæ¯ä¸ªå‘½ä»¤éƒ½è¦åˆ·ï¼Œæœ€æ…¢ä¹Ÿæœ€å®‰å…¨ï¼›</li>
<li><code>everysec</code>ï¼šæ¯ç§’åˆ·ä¸€æ¬¡ï¼ŒæŠ˜ä¸­ï¼›</li>
<li><code>no</code>ï¼šç”±OSå†³å®šä»€ä¹ˆæ—¶å€™åˆ·ï¼Œæœ€å¿«ä¹Ÿæœ€å±é™©ï¼›</li>
</ul>
</li>
</ul>
<p>æ„Ÿè§‰rdbç±»ä¼¼checkpointç”Ÿæˆå…¨é‡çš„å­˜å‚¨ï¼Œå¯åŠ¨åŠ è½½å¿«ï¼Œaofç±»ä¼¼redoï¼Œå¢é‡å†™ç›˜å¿«ã€‚</p>
<h2 id="rdb"><a href="#rdb" class="headerlink" title="rdb"></a>rdb</h2><p>å‘½ä»¤ï¼š</p>
<ul>
<li><code>save</code>ï¼šé˜»å¡ï¼Œé™¤äº†æ‰‹åŠ¨è§¦å‘è¿˜æœ‰ï¼›<ul>
<li><code>shutdown</code>ï¼šå…³æœºï¼›</li>
</ul>
</li>
<li><code>bgsave</code>ï¼šéé˜»å¡é™¤äº†æ‰‹åŠ¨æ˜¾ç¤ºåœ°è§¦å‘<ul>
<li>å®šæ—¶é…ç½®ï¼›</li>
<li>ä¸»ä»å¤åˆ¶ï¼›</li>
<li><code>flushall</code>ï¼šæ¸…ç©ºæ•°æ®ï¼›</li>
</ul>
</li>
</ul>
<p>æµç¨‹ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/07.jpg" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>è½½å…¥æ—¶åªèƒ½å¤„ç†PUBLISHã€SUBSCRIBEç­‰å‘½ä»¤ã€‚</p>
</blockquote>
<h2 id="aof"><a href="#aof" class="headerlink" title="aof"></a>aof</h2><p>å¯ä»¥ç”¨aofåšå…¨é‡æŒä¹…åŒ–ï¼Œä¹Ÿå¯ä»¥é…åˆrdbåšå¢é‡æŒä¹…åŒ–ã€‚æœ¬èº«æ¯”è¾ƒç®€å•ï¼š</p>
<blockquote>
<p>æŠŠå†™æ“ä½œä»¥æ—¥å¿—çš„å½¢å¼ä¿å­˜ä¸‹æ¥ã€‚</p>
</blockquote>
<p>æ¯”è¾ƒå¤æ‚çš„æ˜¯<font color="red">æ—¥å¿—é‡å†™</font>ï¼Œè§¦å‘æ¡ä»¶ï¼š</p>
<blockquote>
<p>AOFçš„æ–‡ä»¶å¤§å°å¤§äºé˜ˆå€¼ï¼Œä¸”è·ç¦»æœ€åä¸€æ¬¡é‡å†™çš„å¢é•¿æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™å°è¯•è§¦å‘é‡å†™ã€‚</p>
</blockquote>
<p>æµç¨‹ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/05.png" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>å¦‚æœæ˜¯æ··åˆæŒä¹…åŒ–ï¼Œåœ¨å­è¿›ç¨‹ä¸­ä¿å­˜aofå‰å…ˆä¿å­˜rdbï¼Œæ¥ç€å†™å…¥aofçš„æ˜¯åé¢çš„æ“ä½œã€‚</p>
<p>çˆ¶è¿›ç¨‹æŒç»­å“åº”è¯·æ±‚ã€‚</p>
<p>è¿‡ç¨‹ä¸­çˆ¶è¿›ç¨‹æŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œé€šè¿‡ç®¡é“å‘Šè¯‰å­è¿›ç¨‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­å®Œæˆè¿½åŠ ï¼Œé¿å…æœ€åä¸€æŠŠçˆ¶è¿›ç¨‹è¦å†™å…¥çš„æ•°æ®å¤ªå¤šå½±å“æ€§èƒ½ã€‚</p>
</blockquote>
<h1 id="å¤šæœºç©æ³•"><a href="#å¤šæœºç©æ³•" class="headerlink" title="å¤šæœºç©æ³•"></a>å¤šæœºç©æ³•</h1><h2 id="ä¸»ä»æ¨¡å¼"><a href="#ä¸»ä»æ¨¡å¼" class="headerlink" title="ä¸»ä»æ¨¡å¼"></a>ä¸»ä»æ¨¡å¼</h2><p>ä½¿ç”¨<code>slaveof</code>å‘½ä»¤å¯ä»¥æŠŠè‡ªå·±è®¾ç½®ä¸ºå¦ä¸€å°æœºå™¨çš„ä»æœåŠ¡å™¨ï¼Œä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>è¯»å†™åˆ†ç¦»</li>
<li>æ•°æ®å®¹ç¾</li>
</ul>
<p>åˆå§‹åŒ–æµç¨‹ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/08.jpg" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>Masteråœ¨åŒæ­¥å‰ä¿å­˜RDBã€‚</p>
<p>Masterç»´æŠ¤å¤åˆ¶ç¼“å­˜åŒºï¼Œé…åˆOFFSETæ¥æ”¯æŒéƒ¨åˆ†é‡åŒæ­¥ï¼Œæœ‰ç‚¹åƒæ–­ç‚¹ç»­ä¼ ã€‚</p>
</blockquote>
<p>åç»­Masterå†™è¯·æ±‚ä¼šå†™å…¥ç¼“å­˜åŒºåŒæ­¥ç»™Slaverï¼Œè€ŒSlaveråˆ™éœ€è¦å®šæ—¶å‘é€å¿ƒè·³ä¿¡æ¯ç»™Masterï¼Œå¿ƒè·³ä¿¡æ¯ä¸­åŒ…å«å½“å‰åç§»é‡ã€‚</p>
<h2 id="å“¨å…µ-Sentinel-æ¨¡å¼"><a href="#å“¨å…µ-Sentinel-æ¨¡å¼" class="headerlink" title="å“¨å…µ(Sentinel)æ¨¡å¼"></a>å“¨å…µ(Sentinel)æ¨¡å¼</h2><p>ç›¸æ¯”ä¸»ä»æ¨¡å¼éœ€è¦æ‰‹å·¥åˆ‡æ¢ï¼Œä½¿ç”¨å“¨å…µæ¨¡å¼å¯ä»¥å®ç°<font color="red">è‡ªåŠ¨åˆ‡æ¢</font>ï¼Œå¯åŠ¨å‘½ä»¤ï¼ˆå•ç‹¬è¿›ç¨‹ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis-server /path/to/sentinel.config --sentinel</div><div class="line">æˆ–</div><div class="line">redis-sentinel /path/to/sentinel.config</div></pre></td></tr></table></figure>
<p>å¯åŠ¨åå»ºç«‹è¿æ¥ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/09.jpg" alt=""></p>
<p>æ•´ä½“æµç¨‹ï¼š</p>
<ul>
<li>å»ºç«‹è¿æ¥ï¼Œè®¢é˜…é¢‘é“ï¼ˆå‘ç°å…¶ä»–å“¨å…µï¼‰ï¼›</li>
<li>å“¨å…µå®šæ—¶å‘é€INFOå‘½ä»¤ï¼Œé€šè¿‡å“åº”æ‹¿åˆ°å…¶ä»–æœºå™¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå‘ç°ä»æœåŠ¡å™¨ï¼‰ï¼›</li>
<li>å“¨å…µå®šæ—¶å‘é€PINGå‘½ä»¤æ¢æµ‹çŠ¶æ€ï¼›</li>
<li>å“¨å…µå‘ç°ä¸»æœåŠ¡å™¨ä¸‹çº¿ä¸”æœ‰è¶³å¤Ÿæ•°é‡çš„å“¨å…µè®¤ä¸ºä¸»æœåŠ¡å™¨ä¸‹çº¿ï¼Œå¼€å§‹æ•…éšœä¿®å¤ï¼š<ul>
<li><code>å“¨å…µé€‰ä¸¾</code>ï¼›</li>
<li><code>é€‰æ–°ä¸»æœåŠ¡å™¨</code>ï¼šæŒ‘é€‰è¶³å¤Ÿå¥åº·çš„ä»æœåŠ¡ï¼šå¿ƒè·³æ­£å¸¸ã€æ•°æ®æœ€æ–°ç­‰ç­‰ï¼›</li>
<li><code>ä»è½¬ä¸»</code>ï¼šå“¨å…µå‘å€™é€‰ä¸»æœºå‘é€slaveof noneå‘½ä»¤ï¼Œä½¿å…¶è½¬å˜æˆä¸€ä¸ªä¸»æœåŠ¡å™¨ï¼›</li>
<li><code>è®¤æ–°ä¸»</code>ï¼šå“¨å…µå‘å…¶ä»–ä»æœºå‘é€slaveof promote_slaveï¼Œä½¿å…¶è½¬å˜ä¸ºå€™é€‰ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼›</li>
<li><code>è€ä¸»å˜ä»</code>ï¼šåœ¨æ—§çš„ä¸»æœåŠ¡å™¨æ¢å¤åï¼Œå“¨å…µä¼šå‘å…¶å‘é€å‘½ä»¤å˜æˆä»æœåŠ¡å™¨ï¼›</li>
</ul>
</li>
</ul>
<h2 id="é›†ç¾¤-Cluster-æ¨¡å¼"><a href="#é›†ç¾¤-Cluster-æ¨¡å¼" class="headerlink" title="é›†ç¾¤(Cluster)æ¨¡å¼"></a>é›†ç¾¤(Cluster)æ¨¡å¼</h2><p>åœ¨<font color="red">æ•°æ®å¤ªå¤šã€å•æœºæ‰›ä¸ä½</font>çš„æ—¶å€™ï¼Œéœ€è¦å¼€å¯é›†ç¾¤æ¨¡å¼ï¼š</p>
<blockquote>
<p>REDISå°†KEYåˆ†äº†16384ä¸ªSLOTï¼Œå•ä¸ªä¸»æœåŠ¡å™¨åªè´Ÿè´£ä¸€éƒ¨åˆ†çš„SLOTã€‚</p>
</blockquote>
<p>åœ¨CLIENTè®¿é—®é›†ç¾¤æ—¶å¦‚æœåˆšå¥½SLOTä¸åœ¨ï¼Œåˆ™ä¼šæ”¶åˆ°MOVEDé‡å®šå‘ï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/10.png" alt=""></p>
<p><strong>tips</strong>ï¼š</p>
<blockquote>
<p>åœ¨CLIENTä¼šæœ‰ç¼“å­˜ï¼Œé¿å…é¢‘ç¹é‡å®šå‘ã€‚</p>
<p>å•æ¡å‘½ä»¤æ“ä½œä¸åŒçš„èŠ‚ç‚¹çš„KEYä¼šæŠ¥é”™ï¼Œå¯ä»¥ç”¨HASH TAGSçš„æœºåˆ¶æŠŠä¸åŒKEYè·¯ç”±åˆ°å•ä¸ªSLOTã€‚</p>
</blockquote>
<p>é›†ç¾¤æ¨¡å¼ä¸­ä¸»ä»æœåŠ¡å™¨çš„å…³ç³»ä¸ºï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/13.jpg" alt=""></p>
<p>ä¸ºäº†æé«˜å¯é æ€§ä¼šå†—ä½™ä»æœåŠ¡å™¨ï¼Œå¦‚æœç»™æ¯ä¸ªèŠ‚ç‚¹éƒ½å†—ä½™ä¼šæ¯”è¾ƒæµªè´¹ï¼Œæ›´å¥½çš„è§£å†³åŠæ³•æ˜¯ï¼š</p>
<blockquote>
<p>é€šè¿‡<font color="red">å‰¯æœ¬æ¼‚ç§»</font>ï¼Œåœ¨ä¸»æœåŠ¡å™¨æŒ‚æ‰ä»¥åï¼Œæ‰¾åˆ°å†—ä½™çš„ä»æœåŠ¡å™¨æŒ‚åˆ°è‡ªå·±ä¸‹é¢ã€‚</p>
</blockquote>
<p>åœ¨ä¸»AæŒ‚æ‰åè°ƒæ•´ä¸ºï¼š</p>
<p><img src="https://tianchi.oss-cn-hangzhou.aliyuncs.com/blog/redis/12.jpg" alt=""></p>
<p>åœ¨æœ‰æ–°èŠ‚ç‚¹åŠ å…¥åï¼Œéœ€è¦é€šè¿‡æŠŠSLOTåœ¨èŠ‚ç‚¹é—´è¿ç§»æ¥é‡æ–°è¾¾åˆ°è´Ÿè½½å‡è¡¡ã€‚</p>
<h1 id="å¸¸è§ç¼“å­˜é—®é¢˜åŠè§£æ³•"><a href="#å¸¸è§ç¼“å­˜é—®é¢˜åŠè§£æ³•" class="headerlink" title="å¸¸è§ç¼“å­˜é—®é¢˜åŠè§£æ³•"></a>å¸¸è§ç¼“å­˜é—®é¢˜åŠè§£æ³•</h1><ul>
<li><code>ç¼“å­˜ç©¿é€</code><ul>
<li><code>æè¿°</code>ï¼šç¼“å­˜æŸ¥ä¸åˆ°æ•°æ®æ—¶ï¼Œä»æ•°æ®åº“æï¼›äºæ˜¯å¯ä»¥åˆ©ç”¨ä¸å­˜åœ¨çš„KEYæ¥æ”»å‡»æ•°æ®åº“ï¼›</li>
<li><code>è§£æ³•</code><ul>
<li>ç¼“å­˜ä¸å­˜åœ¨æ—¶å°±ç®—äº†ï¼Œåœ¨æ•°æ®åº“æœ‰æ›´æ–°æ—¶ï¼ŒåŒæ­¥åˆ°ç¼“å­˜ï¼›</li>
<li>ç¼“å­˜åŒ…è£…ç©ºå€¼ï¼›</li>
<li>å¸ƒéš†è¿‡æ»¤å™¨ä¿å­˜æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„KEYï¼Œåœ¨å–æ•°æ®å‰å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰ï¼›</li>
</ul>
</li>
</ul>
</li>
<li><code>ç¼“å­˜å‡»ç©¿</code><ul>
<li><code>æè¿°</code>ï¼šåœ¨KEYè¿‡æœŸæ—¶å‡ºç°å¤§é‡è®¿é—®ï¼›</li>
<li><code>è§£æ³•</code>ï¼šåœ¨å¤šçº¿ç¨‹è¯»çš„éœ€è¦è½DBæ—¶ï¼Œé€šè¿‡åŠ é”æ¥é¿å…å¤§é‡DBé‡å¤è®¿é—®ï¼Œæœ‰ç‚¹åƒç¼“å­˜Futureï¼›</li>
</ul>
</li>
<li><code>ç¼“å­˜é›ªå´©</code><ul>
<li><code>æè¿°</code>ï¼šçŸ­æ—¶é—´å¤§é‡KEYè¿‡æœŸï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°DBï¼›</li>
<li><code>è§£æ³•</code>ï¼šåœ¨è¿‡æœŸæ—¶é—´åŠ ä¸€å®šçš„éšæœºå€¼ï¼›</li>
</ul>
</li>
<li><code>ç¼“å­˜ä¸€è‡´æ€§</code><ul>
<li><code>æè¿°</code>ï¼šç¼“å­˜ä¸­çš„æ•°æ®å’ŒDBä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼›</li>
<li><code>è§£æ³•</code><ul>
<li><code>Cache aside</code><ul>
<li><code>è¯»å–</code>ï¼šç¼“å­˜ä¸­æ²¡æœ‰åˆ™ä»DBè¯»å–å¹¶æ”¾å…¥ç¼“å­˜ï¼Œç†è®ºä¸Šå¹¶å‘è¯»å†™å°±ä¼šæœ‰ä¸ä¸€è‡´ï¼ˆè¯»åˆ°çš„è€æ•°æ®è¢«å†™åˆ°äº†ç¼“å­˜ï¼‰ï¼›</li>
<li><code>æ›´æ–°</code>ï¼šä¿å­˜DBå¤±æ•ˆç¼“å­˜ï¼Œé¿å…å¹¶å‘å†™å¯¼è‡´çš„ä¸ä¸€è‡´ï¼›</li>
</ul>
</li>
<li><code>Read through</code><ul>
<li><code>è¯»å–</code>ï¼šç¼“å­˜æœåŠ¡å°è£…æ‰ç¼“å­˜ä¸å­˜åœ¨æ—¶å›æŸ¥DBçš„é€»è¾‘ï¼›</li>
</ul>
</li>
<li><code>Write through</code><ul>
<li><code>æ›´æ–°</code>ï¼šç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œç›´æ¥æ›´æ–°DBåè¿”å›ï¼›ç¼“å­˜å­˜åœ¨æ—¶ï¼Œæ›´æ–°DBåå†æ›´æ–°ç¼“å­˜ï¼›</li>
</ul>
</li>
<li><code>Write behind Caching</code><ul>
<li><code>æ›´æ–°</code>ï¼šåªä¿®æ”¹ç¼“å­˜ï¼Œç„¶åå¼‚æ­¥çš„å›å†™åˆ°DBï¼Œç±»ä¼¼PageCacheï¼Œæœ‰å¯èƒ½ä¸¢æ•°æ®ï¼›</li>
</ul>
</li>
<li><code>å…¶ä»–</code><ul>
<li><code>è¯»å–</code>ï¼šä»ç¼“å­˜æŸ¥ä¸åˆ°æ—¶ä¸ä»DBæŸ¥ï¼›</li>
<li><code>æ›´æ–°</code>ï¼šåœ¨DBæ›´æ–°åï¼Œå¢é‡æ‹‰å–ä¿®æ”¹çš„æ•°æ®æˆ–è€…é€šè¿‡ç›‘å¬DBçš„å˜åŒ–æ¥æ›´æ–°ç¼“å­˜ï¼›</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://juejin.im/post/5d71d3bee51d453b5f1a04f1#heading-9" target="_blank" rel="external">æ·±å…¥äº†è§£Redisåº•å±‚æ•°æ®ç»“æ„</a></li>
<li><a href="https://wiki.jikexueyuan.com/project/redis/intset.html" target="_blank" rel="external">Redis æºç æ—¥å¿—</a></li>
<li><a href="http://redisbook.com/" target="_blank" rel="external">Redis è®¾è®¡ä¸å®ç°</a></li>
<li><a href="https://www.cnblogs.com/linxiyue/p/10945216.html" target="_blank" rel="external">Redisä¸­çš„LRUæ·˜æ±°ç­–ç•¥åˆ†æ</a></li>
<li><a href="https://www.cnblogs.com/linxiyue/p/10955533.html" target="_blank" rel="external">Redisä¸­çš„LFUç®—æ³•</a></li>
<li><a href="https://www.cnblogs.com/xuliangxing/p/7151812.html" target="_blank" rel="external">Rediså­¦ä¹ ç¬”è®°â€“Redisæ•°æ®è¿‡æœŸç­–ç•¥è¯¦è§£</a></li>
<li><a href="https://wiki.jikexueyuan.com/project/redis/guard-mechanism.html" target="_blank" rel="external">Rediså“¨å…µæœºåˆ¶</a></li>
<li><a href="https://wenchao.ren/2019/07/Select%E3%80%81Epoll%E3%80%81KQueue%E5%8C%BA%E5%88%AB/" target="_blank" rel="external">Selectã€pollã€Epollã€KQueueåŒºåˆ«</a></li>
<li><a href="https://cbsheng.github.io/posts/redisé‡Œä¸€ä¸ªç®€å•è¯·æ±‚å¦‚ä½•è¢«å¤„ç†/" target="_blank" rel="external">redisé‡Œä¸€ä¸ªç®€å•è¯·æ±‚å¦‚ä½•è¢«å¤„ç†</a></li>
<li><a href="https://juejin.im/post/5bbcc8325188255c74553ae3" target="_blank" rel="external">æ·±å…¥ç†è§£Redisçš„scanå‘½ä»¤</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag">#redis</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/20/spring/" rel="next" title="SPRING">
                <i class="fa fa-chevron-left"></i> SPRING
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/28/distributed/" rel="prev" title="åˆ†å¸ƒå¼åŸºç¡€">
                åˆ†å¸ƒå¼åŸºç¡€ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpeg"
               alt="wsztrush" />
          <p class="site-author-name" itemprop="name">wsztrush</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">61</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">68</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#æ•°æ®æ ¼å¼"><span class="nav-number">1.</span> <span class="nav-text">æ•°æ®æ ¼å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å†…éƒ¨æ ¼å¼"><span class="nav-number">1.1.</span> <span class="nav-text">å†…éƒ¨æ ¼å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sds"><span class="nav-number">1.1.1.</span> <span class="nav-text">sds</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zskiplist"><span class="nav-number">1.1.2.</span> <span class="nav-text">zskiplist</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#list"><span class="nav-number">1.1.3.</span> <span class="nav-text">list</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dict"><span class="nav-number">1.1.4.</span> <span class="nav-text">dict</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#intset"><span class="nav-number">1.1.5.</span> <span class="nav-text">intset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ziplist"><span class="nav-number">1.1.6.</span> <span class="nav-text">ziplist</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quicklist"><span class="nav-number">1.1.7.</span> <span class="nav-text">quicklist</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stream"><span class="nav-number">1.1.8.</span> <span class="nav-text">stream</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ•°æ®ç±»å‹"><span class="nav-number">1.2.</span> <span class="nav-text">æ•°æ®ç±»å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#string"><span class="nav-number">1.2.1.</span> <span class="nav-text">string</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hash"><span class="nav-number">1.2.2.</span> <span class="nav-text">hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#list-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">list</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set"><span class="nav-number">1.2.4.</span> <span class="nav-text">set</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zset"><span class="nav-number">1.2.5.</span> <span class="nav-text">zset</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#é€šç”¨å‘½ä»¤"><span class="nav-number">2.</span> <span class="nav-text">é€šç”¨å‘½ä»¤</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#åŸºç¡€é€»è¾‘æœºåˆ¶"><span class="nav-number">3.</span> <span class="nav-text">åŸºç¡€é€»è¾‘æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#é˜»å¡"><span class="nav-number">3.1.</span> <span class="nav-text">é˜»å¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äº‹ä»¶è½®è¯¢"><span class="nav-number">3.2.</span> <span class="nav-text">äº‹ä»¶è½®è¯¢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äº‹åŠ¡"><span class="nav-number">3.3.</span> <span class="nav-text">äº‹åŠ¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œæµç¨‹"><span class="nav-number">3.4.</span> <span class="nav-text">å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œæµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ·˜æ±°"><span class="nav-number">4.</span> <span class="nav-text">æ·˜æ±°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è¿‡æœŸ"><span class="nav-number">5.</span> <span class="nav-text">è¿‡æœŸ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æŒä¹…åŒ–"><span class="nav-number">6.</span> <span class="nav-text">æŒä¹…åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rdb"><span class="nav-number">6.1.</span> <span class="nav-text">rdb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#aof"><span class="nav-number">6.2.</span> <span class="nav-text">aof</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å¤šæœºç©æ³•"><span class="nav-number">7.</span> <span class="nav-text">å¤šæœºç©æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸»ä»æ¨¡å¼"><span class="nav-number">7.1.</span> <span class="nav-text">ä¸»ä»æ¨¡å¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å“¨å…µ-Sentinel-æ¨¡å¼"><span class="nav-number">7.2.</span> <span class="nav-text">å“¨å…µ(Sentinel)æ¨¡å¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é›†ç¾¤-Cluster-æ¨¡å¼"><span class="nav-number">7.3.</span> <span class="nav-text">é›†ç¾¤(Cluster)æ¨¡å¼</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å¸¸è§ç¼“å­˜é—®é¢˜åŠè§£æ³•"><span class="nav-number">8.</span> <span class="nav-text">å¸¸è§ç¼“å­˜é—®é¢˜åŠè§£æ³•</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">9.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wsztrush</span>
</div>

<!--
<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>


<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

-->

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'wsztrush';
      var disqus_identifier = '2020/04/22/redis/';
      var disqus_title = "REDIS";
      var disqus_url = 'http://yoursite.com/2020/04/22/redis/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        // TODO dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        dsq.src = '//a.disquscdn.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      
    </script>
  




  
  

  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("5q464kOnKNtBvidNUffEyLtK-gzGzoHsz", "OalJXPjfxbJuxfazVb8SjkuH");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
